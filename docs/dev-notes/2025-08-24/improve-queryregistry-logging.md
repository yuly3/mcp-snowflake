# QueryRegistryのロギング改善

## 現在の状況

QueryRegistryクラスには基本的なロギングが実装されているが、以下の課題がある：

1. **ログレベルの偏り**: 主にエラーログと一部の警告ログのみ
2. **デバッグ情報の不足**: 正常な処理フローのログが不足
3. **構造化ログの不在**: プレーンテキストのみ、JSON形式などの構造化ログがない
4. **パフォーマンス情報の不足**: 実行時間やリソース使用量の記録がない
5. **セキュリティ監査情報の不足**: 重要な操作のトレースが不十分

## 改善計画

### 1. 詳細なデバッグログの追加

- クエリ実行の開始・完了
- ステータス遷移の記録
- 接続の作成・クローズ
- ポーリングの開始・停止
- TTLクリーンアップの実行

### 2. 構造化ログの導入

- JSON形式のログ出力
- クエリID、SQL文、実行時間などの構造化データ
- ログ集約・分析システムでの処理を想定

### 3. パフォーマンス測定

- クエリ実行時間の測定
- ポーリング間隔の調整記録
- リソース使用状況

### 4. セキュリティ監査ログ

- クエリの実行開始・完了
- キャンセル操作
- エラーの詳細（ただし機密情報は除外）

### 5. ログレベルの適切な使用

- DEBUG: 詳細な処理フロー
- INFO: 重要な処理の開始・完了
- WARNING: 予期しない状況だが処理継続可能
- ERROR: エラー状況

## 実装方針

1. 既存のログ出力を維持しつつ改善
2. 新しい構造化ログ機能をオプションとして追加
3. パフォーマンスへの影響を最小化
4. テスト可能な設計

## 実装結果

### 追加された機能

#### 1. 構造化ログヘルパーメソッド

- `_log_query_event()`: クエリ関連のイベントログ
- `_log_performance()`: パフォーマンス測定ログ

#### 2. 詳細なロギングが追加されたメソッド

- `__init__()`: QueryRegistry初期化時のログ
- `execute_query()`:
  - 実行開始/完了のログ
  - SQL文のプレビュー（機密情報を考慮して最初100文字のみ）
  - パフォーマンス測定
  - エラー詳細ログ
- `cancel()`:
  - キャンセル要求/完了のログ
  - 各段階の詳細ログ
  - パフォーマンス測定
- `prune_expired()`:
  - TTLクリーンアップの開始/完了ログ
  - 削除対象クエリの詳細
  - パフォーマンス測定
- `close()`:
  - シャットダウンプロセスの詳細ログ
  - リソースクリーンアップの統計
  - パフォーマンス測定
- 各プライベートメソッドにも適切なログ追加

#### 3. 構造化ログ形式

すべてのログに以下の構造化データが含まれる：

```python
{
    "component": "QueryRegistry",
    "action": "specific_action_name",
    "query_id": "query-uuid",
    "duration_ms": 123.45,  # パフォーマンスログの場合
    "error_type": "ExceptionType",  # エラーログの場合
    "error_message": "詳細なエラーメッセージ"
}
```

#### 4. パフォーマンス測定

主要な操作（execute_query, cancel, prune_expired, close, handle_completion）に
実行時間測定を追加。

#### 5. セキュリティ考慮事項

- SQL文は最初100文字のみログに記録（機密情報漏洩防止）
- エラーメッセージも適切にフィルタリング
- クエリIDを使った追跡可能性

### テスト結果

- 全30個のテストがパス ✅
- 既存機能への影響なし ✅
- ロギング機能の動作確認済み ✅

### 改善効果

1. **運用性向上**: 詳細なログによりトラブルシューティングが容易に
2. **パフォーマンス監視**: 各操作の実行時間を測定・監視可能
3. **セキュリティ監査**: 重要な操作のトレーサビリティ確保
4. **構造化ログ**: ログ集約システムでの分析・検索が容易
5. **デバッグ支援**: 詳細な処理フローの可視化

### 今後の拡張可能性

- ログレベルの動的変更機能
- メトリクス収集システムとの連携
- アラート機能との統合
- ログローテーション機能
- ログの圧縮・アーカイブ機能

## ログユーティリティの分離

### 追加実装 (2025-08-24 12:30)

QueryRegistryクラスからログユーティリティメソッドを別ファイルに分離し、再利用可能な独立したモジュールとして整理しました。

#### 新しいファイル構造

**`packages/query-registry/src/query_registry/logging_utils.py`**
```python
# 3つのログユーティリティ関数を提供:
- log_query_event(): クエリ関連のイベントログ
- log_performance(): パフォーマンス測定ログ
- log_registry_event(): 汎用レジストリイベントログ
```

**`tests/query_registry/test_logging_utils.py`**
```python
# 8つのテストケースで完全にカバー:
- 基本的なログ機能のテスト
- 追加データを含むログのテスト
- モックロガーと実際のロガーの両方でテスト
```

#### 分離のメリット

1. **再利用性**: 他のコンポーネントでも同じログユーティリティを使用可能
2. **テスタビリティ**: ログ機能を独立してテスト可能
3. **保守性**: ログ機能の変更が他のコードに影響しない
4. **関心の分離**: QueryRegistryクラスはクエリ管理のみに専念
5. **モジュール性**: 小さく独立したモジュールで管理

#### 変更内容

- `QueryRegistry`クラスから`_log_query_event()`と`_log_performance()`メソッドを削除
- 新しい`logging_utils`モジュールに3つのユーティリティ関数を実装
- 全てのログ呼び出しを新しいユーティリティ関数に置き換え
- 包括的なテストスイートを追加

#### テスト結果

- **新しいログユーティリティテスト**: 8個すべてパス ✅
- **既存のQueryRegistryテスト**: 32個すべてパス ✅
- **総テスト数**: 40個すべてパス ✅
- **Lintチェック**: エラーなし ✅

この分離により、QueryRegistryのロギング機能はより保守しやすく、再利用可能で、テスト可能なアーキテクチャになりました。
